<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KUCCPS Course Checker - Diploma Programs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- EmailJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Paystack Library -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    
    <!-- Our JS Files -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/AUTH.js"></script>
    <script src="js/payment.js"></script>
    <script src="js/calculator.js"></script>
    <script src="js/grades.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .navbar-custom {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-custom .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .back-link {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            padding: 8px 16px;
            border-radius: 50px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-3px);
        }

        .payment-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59,130,246,0.3);
        }

        .main-content {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0f172a;
            text-align: center;
            margin-bottom: 10px;
        }

        .page-subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 40px;
        }

        .form-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title i {
            transition: transform 0.3s ease;
        }

        .section-title.collapsed i {
            transform: rotate(-90deg);
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            transition: all 0.3s ease;
        }

        .subject-grid.collapsed {
            display: none;
        }

        .subject-item label {
            display: block;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 5px;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        select:focus {
            outline: none;
            border-color: #10b981;
        }

        .main-grade-select {
            max-width: 400px;
        }

        .check-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px auto 40px;
            display: block;
            min-width: 280px;
            box-shadow: 0 4px 6px rgba(16,185,129,0.2);
            transition: all 0.3s ease;
        }

        .check-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16,185,129,0.3);
        }

        /* Payment Modal - Your Exact Design */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .payment-modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            border: 4px solid #10b981;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .payment-modal-content h3 {
            font-size: 2rem;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 10px;
        }

        .payment-amount {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 40px;
            border-radius: 60px;
            display: inline-block;
            font-size: 2.2rem;
            font-weight: 700;
            margin: 20px 0;
        }

        .payment-form {
            text-align: left;
            margin: 20px 0;
        }

        .payment-form .form-group {
            margin-bottom: 20px;
        }

        .payment-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e293b;
            font-size: 0.95rem;
        }

        .payment-form label i {
            color: #10b981;
            margin-right: 8px;
        }

        .payment-form input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .payment-form input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16,185,129,0.1);
        }

        .payment-form .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-pay {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0 10px;
            transition: all 0.3s ease;
        }

        .btn-pay:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16,185,129,0.4);
        }

        .btn-pay:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-cancel {
            width: 100%;
            background: #ef4444;
            color: white;
            border: none;
            padding: 14px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239,68,68,0.3);
        }

        .payment-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            display: none;
            text-align: center;
        }

        .payment-status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .payment-status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .payment-status.processing {
            background: #cce5ff;
            color: #004085;
            display: block;
        }

        /* Results Section */
        .results-section {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 30px;
            margin: 40px 0;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-header h2 {
            font-size: 1.8rem;
            color: #0f172a;
            margin: 0;
        }

        .results-summary {
            background: #d1fae5;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.9rem;
            color: #64748b;
        }

        .summary-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
        }

        .category-title {
            font-size: 1.5rem;
            color: #10b981;
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .course-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .course-card.eligible {
            border-left-color: #10b981;
        }

        .course-card.not-eligible {
            border-left-color: #ef4444;
            opacity: 0.7;
        }

        .course-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 5px;
        }

        .institution {
            color: #10b981;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .course-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .detail-item {
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .detail-item .label {
            color: #64748b;
            margin-right: 5px;
        }

        .detail-item .value {
            font-weight: 600;
            color: #0f172a;
        }

        .requirements {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .requirements h6 {
            font-size: 0.95rem;
            margin-bottom: 10px;
            color: #64748b;
        }

        .requirement-item {
            display: inline-block;
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0 5px 5px 0;
        }

        .requirement-item.met {
            background: #d4edda;
            color: #155724;
        }

        .requirement-item.not-met {
            background: #f8d7da;
            color: #721c24;
        }

        .eligibility-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .eligibility-badge.eligible {
            background: #d4edda;
            color: #155724;
        }

        .eligibility-badge.not-eligible {
            background: #f8d7da;
            color: #721c24;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .existing-payment-banner {
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            display: none;
        }

        .footer {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-top: 60px;
        }

        .copyright {
            color: #64748b;
            font-size: 0.9rem;
            border-top: 1px solid #334155;
            padding-top: 30px;
        }

        @media (max-width: 768px) {
            .subject-grid {
                grid-template-columns: 1fr;
            }
            .payment-form .row {
                grid-template-columns: 1fr;
            }
            .results-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar-custom">
        <div class="container">
            <div class="back-link" onclick="goBack()">
                <i class="bi bi-arrow-left"></i> Back
            </div>
            
            <!-- Only Already Paid button -->
            <a class='payment-btn' href='alreadypaid.html'>
                <i class="bi bi-question-circle-fill"></i> Already Paid?
            </a>
        </div>
    </nav>

    <main class="main-content">
        <h1 class="page-title">KUCCPS COURSE CHECKER - DIPLOMA PROGRAMS</h1>
        <p class="page-subtitle">Enter your KCSE grades to find all diploma courses you qualify for</p>

        <div id="existingPaymentBanner" class="existing-payment-banner">
            <h4><i class="bi bi-check-circle-fill"></i> Payment Verified</h4>
            <p>You have already made a payment. Your results will be shown immediately.</p>
        </div>

        <form id="gradeForm">
            <div class="form-section">
                <h2 class="section-title">Main KCSE Grade</h2>
                <div class="main-grade-select">
                    <label for="kcse_mean_grade">Overall KCSE Grade <span style="color: #ef4444;">*</span></label>
                    <select id="kcse_mean_grade" required>
                        <option value="">Select grade</option>
                        <option value="A">A (12 points)</option>
                        <option value="A-">A- (11 points)</option>
                        <option value="B+">B+ (10 points)</option>
                        <option value="B">B (9 points)</option>
                        <option value="B-">B- (8 points)</option>
                        <option value="C+">C+ (7 points)</option>
                        <option value="C">C (6 points)</option>
                        <option value="C-">C- (5 points)</option>
                        <option value="D+">D+ (4 points)</option>
                        <option value="D">D (3 points)</option>
                        <option value="D-">D- (2 points)</option>
                        <option value="E">E (1 point)</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">Core Subjects</h2>
                <div class="subject-grid">
                    <div class="subject-item">
                        <label>Mathematics</label>
                        <select id="math">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                    <div class="subject-item">
                        <label>English</label>
                        <select id="english">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                    <div class="subject-item">
                        <label>Kiswahili</label>
                        <select id="kiswahili">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">Sciences</h2>
                <div class="subject-grid">
                    <div class="subject-item">
                        <label>Chemistry</label>
                        <select id="chemistry">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                    <div class="subject-item">
                        <label>Biology</label>
                        <select id="biology">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                    <div class="subject-item">
                        <label>Physics</label>
                        <select id="physics">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">Humanities</h2>
                <div class="subject-grid">
                    <div class="subject-item">
                        <label>History</label>
                        <select id="history">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                    <div class="subject-item">
                        <label>Geography</label>
                        <select id="geography">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                    <div class="subject-item">
                        <label>CRE</label>
                        <select id="cre">
                            <option value="">Select grade</option>
                            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
                            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
                            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
                            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- TECHNICAL SUBJECTS - DROPDOWN MENU STYLE -->
            <div class="form-section">
                <h2 class="section-title" onclick="toggleTechnicalSubjects()">
                    Technical Subjects <small style="font-weight: normal; color: #64748b;">(Optional)</small>
                    <i class="bi bi-chevron-down" id="techArrow"></i>
                </h2>
                <div id="technicalSubjectsGrid" class="subject-grid">
                    <div class="subject-item"><label>Agriculture</label><select id="agriculture"></select></div>
                    <div class="subject-item"><label>Computer Studies</label><select id="computer"></select></div>
                    <div class="subject-item"><label>Art And Design</label><select id="art"></select></div>
                    <div class="subject-item"><label>Woodwork</label><select id="woodwork"></select></div>
                    <div class="subject-item"><label>Homescience</label><select id="homescience"></select></div>
                    <div class="subject-item"><label>Business Studies</label><select id="business"></select></div>
                    <div class="subject-item"><label>Music</label><select id="music"></select></div>
                    <div class="subject-item"><label>Building And Construction</label><select id="building"></select></div>
                    <div class="subject-item"><label>Electricity And Electronics</label><select id="electricity"></select></div>
                    <div class="subject-item"><label>Metalwork</label><select id="metalwork"></select></div>
                    <div class="subject-item"><label>French</label><select id="french"></select></div>
                    <div class="subject-item"><label>German</label><select id="german"></select></div>
                    <div class="subject-item"><label>Aviation</label><select id="aviation"></select></div>
                </div>
            </div>

            <button type="button" class="check-btn" id="findCoursesBtn">
                <i class="bi bi-calculator"></i> Find My Diploma Courses
            </button>
        </form>

        <div id="resultsSection" class="results-section">
            <div class="results-header">
                <h2>Your Eligibility Results</h2>
                <div class="loading-spinner" id="resultsSpinner" style="display: none;"></div>
            </div>
            
            <div class="results-summary" id="resultsSummary"></div>
            
            <div id="resultsContent"></div>
        </div>
    </main>

    <!-- Payment Modal - Your Exact Design -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-modal-content">
            <h3>üí∞ Complete Payment</h3>
            <p>Pay once to unlock your personalized results</p>
            <div class="payment-amount">KES 200</div>
            
            <div class="payment-form">
                <div class="form-group">
                    <label><i class="bi bi-person-fill"></i> Full Name</label>
                    <input type="text" id="paymentFullName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label><i class="bi bi-envelope-fill"></i> Email Address</label>
                    <input type="email" id="paymentEmail" placeholder="your@email.com" required>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label><i class="bi bi-phone-fill"></i> Phone Number</label>
                        <input type="tel" id="paymentPhone" placeholder="0712345678" required>
                    </div>
                    <div class="form-group">
                        <label><i class="bi bi-card-text"></i> Index Number</label>
                        <input type="text" id="paymentIndex" placeholder="e.g., 2020/123456" required>
                    </div>
                </div>
                
                <button type="button" class="btn-pay" id="payNowBtn">
                    <i class="bi bi-lock-fill"></i> Pay KES 200 Now
                </button>
                
                <div id="paymentStatus" class="payment-status"></div>
                
                <button type="button" class="btn-cancel" onclick="closePaymentModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="copyright">
                &copy; 2026 KUCCPS Course Checker. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init('OJTlrpQojM9U40Ez3');
        })();

        // Navigation
        function goBack() {
            window.history.back();
        }

        // Grade options for technical subjects
        const gradeOptions = `
            <option value="">Select grade</option>
            <option value="A">A</option><option value="A-">A-</option><option value="B+">B+</option>
            <option value="B">B</option><option value="B-">B-</option><option value="C+">C+</option>
            <option value="C">C</option><option value="C-">C-</option><option value="D+">D+</option>
            <option value="D">D</option><option value="D-">D-</option><option value="E">E</option>
        `;

        // Populate technical subjects
        document.querySelectorAll('#technicalSubjectsGrid select').forEach(select => {
            select.innerHTML = gradeOptions;
        });

        let collectedGrades = {};

        // Toggle technical subjects
        function toggleTechnicalSubjects() {
            const grid = document.getElementById('technicalSubjectsGrid');
            const arrow = document.getElementById('techArrow');
            
            if (grid.classList.contains('collapsed')) {
                grid.classList.remove('collapsed');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                grid.classList.add('collapsed');
                arrow.style.transform = 'rotate(-90deg)';
            }
        }

        // Collect grades and process
        async function collectGrades() {
            collectedGrades = {
                meanGrade: document.getElementById('kcse_mean_grade').value,
                Mathematics: document.getElementById('math').value,
                English: document.getElementById('english').value,
                Kiswahili: document.getElementById('kiswahili').value,
                Chemistry: document.getElementById('chemistry').value,
                Biology: document.getElementById('biology').value,
                Physics: document.getElementById('physics').value,
                History: document.getElementById('history').value,
                Geography: document.getElementById('geography').value,
                CRE: document.getElementById('cre').value,
                Agriculture: document.getElementById('agriculture').value,
                Computer: document.getElementById('computer').value,
                Business: document.getElementById('business').value,
                Art: document.getElementById('art')?.value || '',
                Woodwork: document.getElementById('woodwork')?.value || '',
                Homescience: document.getElementById('homescience')?.value || '',
                Music: document.getElementById('music')?.value || '',
                Building: document.getElementById('building')?.value || '',
                Electricity: document.getElementById('electricity')?.value || '',
                Metalwork: document.getElementById('metalwork')?.value || '',
                French: document.getElementById('french')?.value || '',
                German: document.getElementById('german')?.value || '',
                Aviation: document.getElementById('aviation')?.value || ''
            };
            
            if (!collectedGrades.meanGrade) {
                Utils.showNotification('Please select your KCSE Mean Grade', 'warning');
                return;
            }

            // Check login
            const user = Utils.getStorage('currentUser');
            if (!user) {
                Utils.showNotification('Please login first', 'warning');
                window.location.href = '/index.html';
                return;
            }

            // Check payment status from API (not just localStorage)
            try {
                const statusResponse = await fetch(`${CONFIG.APP.API_URL}/payments/status/${user.id}`);
                const statusData = await statusResponse.json();
                
                if (statusData.success && statusData.data.hasPaid) {
                    // Update local storage
                    user.paymentStatus = true;
                    Utils.setStorage('currentUser', user);
                    await fetchAndDisplayResults('diploma');
                } else {
                    // Show payment modal
                    document.getElementById('paymentModal').style.display = 'flex';
                }
            } catch (error) {
                // Fallback to local storage check
                if (user.paymentStatus) {
                    await fetchAndDisplayResults('diploma');
                } else {
                    document.getElementById('paymentModal').style.display = 'flex';
                }
            }
        }

        // Fetch and display results from API
        async function fetchAndDisplayResults(programType = 'diploma') {
            const spinner = document.getElementById('resultsSpinner');
            const resultsDiv = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            const resultsSummary = document.getElementById('resultsSummary');
            
            spinner.style.display = 'inline-block';
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p class="text-center">Loading your results...</p>';
            
            try {
                const user = Utils.getStorage('currentUser');
                
                // Call API to calculate eligibility
                const response = await API.calculateEligibility(user.id, programType, collectedGrades);
                
                spinner.style.display = 'none';
                
                if (response && response.success) {
                    const data = response.data;
                    
                    // Display summary
                    resultsSummary.innerHTML = `
                        <div class="summary-item">
                            <div class="label">Mean Grade</div>
                            <div class="value">${data.summary?.meanGrade || 'N/A'}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Total Points</div>
                            <div class="value">${data.summary?.totalPoints || 'N/A'}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Eligible Courses</div>
                            <div class="value">${data.courses ? data.courses.length : 0}</div>
                        </div>
                    `;
                    
                    // Display courses
                    if (data.courses && data.courses.length > 0) {
                        let html = '<h3 class="category-title">üìú Eligible Diploma Programs</h3>';
                        
                        data.courses.forEach(course => {
                            const isEligible = checkEligibility(course, collectedGrades);
                            const eligibleClass = isEligible ? 'eligible' : 'not-eligible';
                            
                            html += `
                                <div class="course-card ${eligibleClass}">
                                    <div class="course-name">${course.name}</div>
                                    <div class="institution">${course.institution_name || 'Various Institutions'}</div>
                                    
                                    <div class="course-details">
                                        ${course.cut_off_points ? `
                                            <div class="detail-item">
                                                <span class="label">Cut-off:</span>
                                                <span class="value">${course.cut_off_points}</span>
                                            </div>
                                        ` : ''}
                                        ${course.duration_years ? `
                                            <div class="detail-item">
                                                <span class="label">Duration:</span>
                                                <span class="value">${course.duration_years} years</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    ${course.requirements ? `
                                        <div class="requirements">
                                            <h6>Subject Requirements:</h6>
                                            ${formatRequirements(course.requirements, collectedGrades)}
                                        </div>
                                    ` : ''}
                                    
                                    <div class="eligibility-badge ${eligibleClass}">
                                        ${isEligible ? '‚úÖ You qualify' : '‚ùå You do not qualify'}
                                    </div>
                                </div>
                            `;
                        });
                        
                        resultsContent.innerHTML = html;
                    } else {
                        resultsContent.innerHTML = '<p class="text-center">No diploma courses match your grades.</p>';
                    }
                } else {
                    throw new Error(response?.message || 'Failed to fetch results');
                }
            } catch (error) {
                spinner.style.display = 'none';
                resultsContent.innerHTML = `<p class="text-center text-danger">Error: ${error.message}</p>`;
                console.error('Error fetching results:', error);
            }
        }

        // Check if student meets course requirements
        function checkEligibility(course, grades) {
            if (!course.requirements) return true;
            
            const gradePoints = {
                'A': 12, 'A-': 11, 'B+': 10, 'B': 9, 'B-': 8,
                'C+': 7, 'C': 6, 'C-': 5, 'D+': 4, 'D': 3,
                'D-': 2, 'E': 1
            };
            
            for (const req of course.requirements) {
                const subject = req.subject || req.subject_code;
                const studentGrade = grades[subject];
                
                if (!studentGrade) return false;
                
                const studentPoints = gradePoints[studentGrade] || 0;
                const requiredPoints = gradePoints[req.minimum_grade] || 0;
                
                if (studentPoints < requiredPoints) return false;
            }
            
            return true;
        }

        // Format requirements for display
        function formatRequirements(requirements, grades) {
            const gradePoints = {
                'A': 12, 'A-': 11, 'B+': 10, 'B': 9, 'B-': 8,
                'C+': 7, 'C': 6, 'C-': 5, 'D+': 4, 'D': 3,
                'D-': 2, 'E': 1
            };
            
            return requirements.map(req => {
                const subject = req.subject || req.subject_code;
                const studentGrade = grades[subject];
                const required = req.minimum_grade;
                
                let met = false;
                if (studentGrade) {
                    const studentPoints = gradePoints[studentGrade] || 0;
                    const requiredPoints = gradePoints[required] || 0;
                    met = studentPoints >= requiredPoints;
                }
                
                const metClass = met ? 'met' : 'not-met';
                const metIcon = met ? '‚úì' : '‚úó';
                
                return `
                    <span class="requirement-item ${metClass}">
                        ${subject}: ${studentGrade || '‚Äî'} / ${required} ${metIcon}
                    </span>
                `;
            }).join('');
        }

        // Close payment modal
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        // Handle payment - FIXED: Redirect to Paystack payment link
        document.getElementById('payNowBtn')?.addEventListener('click', async function() {
            const fullName = document.getElementById('paymentFullName').value;
            const email = document.getElementById('paymentEmail').value;
            const phone = document.getElementById('paymentPhone').value;
            const indexNumber = document.getElementById('paymentIndex').value;

            if (!fullName || !email || !phone || !indexNumber) {
                Utils.showNotification('Please fill in all fields', 'warning');
                return;
            }

            if (!Utils.validateEmail(email)) {
                Utils.showNotification('Please enter a valid email', 'error');
                return;
            }

            if (!Utils.validatePhone(phone)) {
                Utils.showNotification('Please enter a valid phone number (e.g., 0712345678)', 'error');
                return;
            }

            const user = Utils.getStorage('currentUser');
            if (!user) {
                Utils.showNotification('Please login first', 'warning');
                window.location.href = '/index.html';
                return;
            }

            // Update user info
            user.fullName = fullName;
            user.email = email;
            user.phone = phone;
            user.indexNumber = indexNumber;
            Utils.setStorage('currentUser', user);

            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.className = 'payment-status processing';
            statusDiv.innerHTML = '<div class="loading-spinner"></div> Processing payment...';
            statusDiv.style.display = 'block';

            try {
                // Initialize payment with backend
                const response = await fetch(`${CONFIG.APP.API_URL}/payments/initialize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: user.id,
                        email: email,
                        amount: 200,
                        metadata: {
                            fullName,
                            phone,
                            indexNumber,
                            grades: collectedGrades,
                            programType: 'diploma'
                        }
                    })
                });

                const data = await response.json();

                if (data && data.success) {
                    // Store payment data temporarily
                    localStorage.setItem('pendingPayment', JSON.stringify({
                        reference: data.data.reference,
                        userId: user.id,
                        email: email,
                        fullName: fullName,
                        phone: phone,
                        indexNumber: indexNumber,
                        grades: collectedGrades,
                        programType: 'diploma'
                    }));

                    // FIXED: Use your actual Paystack payment link
                    const paymentUrl = new URL('https://paystack.com/pay/kuccps-checker');
                    paymentUrl.searchParams.append('email', email);
                    paymentUrl.searchParams.append('reference', data.data.reference);
                    paymentUrl.searchParams.append('user_id', user.id);
                    paymentUrl.searchParams.append('customer_name', fullName);
                    paymentUrl.searchParams.append('phone', phone);
                    paymentUrl.searchParams.append('index_number', indexNumber);

                    // Redirect to Paystack payment page
                    window.location.href = paymentUrl.toString();
                } else {
                    throw new Error(data?.message || 'Payment initialization failed');
                }
            } catch (error) {
                statusDiv.className = 'payment-status error';
                statusDiv.innerHTML = '‚ùå Payment failed. Please try again.';
                console.error('Payment error:', error);
                
                // Re-enable pay button after 3 seconds
                setTimeout(() => {
                    const payBtn = document.getElementById('payNowBtn');
                    if (payBtn) payBtn.disabled = false;
                }, 3000);
            }
        });

        // Attach to check button
        document.getElementById('findCoursesBtn').addEventListener('click', collectGrades);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target === modal) {
                closePaymentModal();
            }
        };

        // Check for existing payment banner
        document.addEventListener('DOMContentLoaded', function() {
            const user = Utils.getStorage('currentUser');
            if (user && user.paymentStatus) {
                document.getElementById('existingPaymentBanner').style.display = 'block';
            }
            
            // Check if returning from payment
            const urlParams = new URLSearchParams(window.location.search);
            const reference = urlParams.get('reference');
            if (reference) {
                // Show results immediately
                setTimeout(() => {
                    document.getElementById('existingPaymentBanner').style.display = 'block';
                    collectGrades();
                }, 1000);
            }
        });
    </script>
</body>
</html>
